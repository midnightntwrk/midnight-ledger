name: Generate markdown docs

on:
  workflow_call:
    inputs:
      branch:
        type: string
        required: true
  workflow_dispatch:
    inputs:
      branch:
        description: 'Which branch you want markdown generated from. (PR will be created to it)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  #v5.0.0

      - name: Install dependencies
        run: |
          npm install --save-dev typedoc-plugin-markdown
          npm install -g rimraf

      - name: Build markdown docs
        run: |
          git config --global user.name 'MidnightCI'
          git config --global user.email 'midnight-automation+midnightci@iohk.io'

          BRANCH=${{ github.event.inputs.branch || github.ref_name }}
          NEW_BRANCH=doc-generation

          git checkout -B $NEW_BRANCH

          cd ledger-wasm && npm run build:markdown-docs
          cd ../onchain-runtime-wasm && npm run build:markdown-docs
          cd ../zswap-wasm && npm run build:markdown-docs

          cd ..
          git add docs/
          git commit -m 'Generated documentation'
          git push --force origin $NEW_BRANCH

  create-pr:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Check if PR already exists
        id: check-pr
        run: |
          BRANCH=${{ github.event.inputs.branch || github.ref_name }}
          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls"
          PR_EXISTS=$(curl -s -H "Authorization: token ${{ secrets.GH_PASSWORD }}" "$API_URL?head=doc-generation&base=$BRANCH" | jq 'length')
          if [[ "$PR_EXISTS" -eq "0" ]]; then
            echo "create_pr=true" >> $GITHUB_ENV
          fi

      - name: Create PR via GitHub API
        if: env.create_pr == 'true'
        run: |
          BRANCH=${{ github.event.inputs.branch || github.ref_name }}
          PR_TITLE="Automated Documentation Update"
          PR_BODY="This PR contains the latest generated markdown documentation."
          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls"

          curl -X POST "$API_URL" \
            -H "Authorization: token ${{ secrets.GH_PASSWORD }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"title\": \"$PR_TITLE\", \"body\": \"$PR_BODY\", \"head\": \"doc-generation\", \"base\": \"$BRANCH\"}"
