# External PCR Publication Guide

## Overview

PCR (Platform Configuration Register) measurements are published **externally** rather than embedded in the proof server binary. This design choice solves several critical issues:

1. **Avoids circular dependency**: Embedding PCRs in the binary changes the binary, which changes PCR0
2. **Enables reproducible builds**: Anyone can rebuild the enclave and independently verify PCR values
3. **Supports transparency**: Multiple publication channels increase trust
4. **Allows flexible updates**: PCRs can be published before/after deployment without rebuild

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    PCR Publication Flow                      │
└─────────────────────────────────────────────────────────────┘

1. Build Enclave
   ├─> Extract PCR measurements from build output
   └─> Save to pcr-measurements-<version>.json

2. Publish Externally (choose one or more)
   ├─> GitHub Release (versioned, auditable)
   ├─> CDN/S3 (fast, globally distributed)
   ├─> Static web hosting (simple)
   └─> On-chain (immutable, decentralized)

3. Client Verification
   ├─> Fetch PCRs from published source
   ├─> Request attestation from proof server
   ├─> Compare PCRs in attestation vs published
   └─> Verify certificate chain and nonce
```

## Publication Methods

### Method 1: GitHub Release (Recommended)

**Advantages:**
- Version controlled and auditable
- Automatic via CI/CD
- Accessible to community for verification
- Can sign releases with GPG

**Process:**

```bash
# After deployment
cd tee-proof-server-proto

# The PCR file is generated by deploy-nitro-enclave.sh
ls pcr-measurements-v6.3.1.json

# Publish to GitHub
./publish-pcr-to-github.sh v6.3.1

# Or manually:
gh release create v6.3.1 \
  --title "Proof Server v6.3.1" \
  --notes "PCR measurements for v6.3.1" \
  pcr-measurements-v6.3.1.json
```

**Client Access:**
```
https://github.com/midnight/midnight-ledger/releases/download/v6.3.1/pcr-measurements.json
```

### Method 2: Static File Hosting

**Advantages:**
- Simple to set up
- Low latency
- Easy to update

**Process:**

```bash
# Copy to web server
scp pcr-measurements-v6.3.1.json user@server:/var/www/html/.well-known/pcr-measurements.json

# Or use nginx to serve from specific location
```

**Nginx Configuration:**
```nginx
location /.well-known/pcr-measurements.json {
    alias /var/www/pcr-measurements/latest.json;
    add_header Content-Type application/json;
    add_header Access-Control-Allow-Origin *;
    add_header Cache-Control "public, max-age=300"; # 5 minute cache
}
```

**Client Access:**
```
https://proof-test.devnet.midnight.network/.well-known/pcr-measurements.json
```

### Method 3: S3 + CloudFront (Production)

**Advantages:**
- Globally distributed (low latency worldwide)
- Highly available
- Automatic HTTPS
- Version history

**Process:**

```bash
# Upload to S3
aws s3 cp pcr-measurements-v6.3.1.json \
  s3://midnight-proof-server-pcrs/v6.3.1/pcr-measurements.json \
  --acl public-read \
  --content-type application/json \
  --cache-control "public, max-age=300"

# Copy to 'latest' for convenience
aws s3 cp s3://midnight-proof-server-pcrs/v6.3.1/pcr-measurements.json \
  s3://midnight-proof-server-pcrs/latest/pcr-measurements.json \
  --acl public-read
```

**CloudFront Distribution:**
- Origin: s3://midnight-proof-server-pcrs
- HTTPS only
- Compress objects
- Price class: Use all edge locations

**Client Access:**
```
https://cdn.midnight.network/proof-server/v6.3.1/pcr-measurements.json
https://cdn.midnight.network/proof-server/latest/pcr-measurements.json
```

### Method 4: Multiple Channels (Best Practice)

Publish to **multiple locations** for redundancy and transparency:

```bash
# 1. GitHub (canonical source)
./publish-pcr-to-github.sh v6.3.1

# 2. S3/CDN (fast access)
aws s3 cp pcr-measurements-v6.3.1.json s3://...

# 3. Static hosting (backup)
scp pcr-measurements-v6.3.1.json server:/var/www/html/.well-known/
```

Clients can try multiple sources with fallback logic.

## Client Integration

### Lace Wallet Configuration

```typescript
// Configure PCR fetch locations (in priority order)
const PCR_SOURCES = [
  'https://cdn.midnight.network/proof-server/v6.3.1/pcr-measurements.json',
  'https://github.com/midnight/midnight-ledger/releases/download/v6.3.1/pcr-measurements.json',
  'https://proof-test.devnet.midnight.network/.well-known/pcr-measurements.json'
];

// Fetch with fallback
async function fetchExpectedPCRs(): Promise<PCRMeasurements> {
  for (const source of PCR_SOURCES) {
    try {
      const response = await fetch(source);
      if (response.ok) {
        return await response.json();
      }
    } catch (error) {
      console.warn(`Failed to fetch from ${source}:`, error);
    }
  }
  throw new Error('Could not fetch PCR measurements from any source');
}

// Verify attestation
async function verifyAttestation(proofServerUrl: string, nonce: string) {
  // 1. Fetch expected PCRs
  const expectedPCRs = await fetchExpectedPCRs();

  // 2. Request attestation
  const attestation = await fetch(`${proofServerUrl}/attestation?nonce=${nonce}`)
    .then(r => r.json());

  // 3. Decode attestation document (CBOR)
  const doc = decodeAttestationDocument(attestation.attestation);

  // 4. Verify PCRs match
  if (doc.pcrs.PCR0 !== expectedPCRs.measurements.pcr0.value) {
    throw new Error('PCR0 mismatch - untrusted enclave');
  }

  // ... verify PCR1, PCR2, certificate chain, nonce, timestamp

  return { verified: true, measurements: doc.pcrs };
}
```

## Deployment Workflow

### Standard Deployment

```bash
# 1. Deploy enclave (extracts PCRs automatically)
./deploy-nitro-enclave.sh

# Output shows:
# [SUCCESS] PCR measurements saved to: pcr-measurements-v6.3.1.json

# 2. Publish PCRs
./publish-pcr-to-github.sh v6.3.1

# 3. (Optional) Publish to additional channels
aws s3 cp pcr-measurements-v6.3.1.json s3://...

# 4. Verify publication
curl https://github.com/midnight/midnight-ledger/releases/download/v6.3.1/pcr-measurements.json | jq '.'

# 5. Test end-to-end
curl https://proof-test.devnet.midnight.network/attestation?nonce=test | jq '.'
```

### CI/CD Automation

```yaml
# .github/workflows/deploy-proof-server.yml
name: Deploy Proof Server

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build and deploy enclave
        run: |
          # SSH to EC2, run deployment
          ssh ec2-user@proof-server "cd midnight-ledger && ./deploy-nitro-enclave.sh"

      - name: Fetch PCR measurements
        run: |
          scp ec2-user@proof-server:pcr-measurements-*.json .

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          files: pcr-measurements-*.json
          body: |
            ## PCR Measurements

            Reproducible build from commit ${{ github.sha }}

      - name: Publish to S3
        run: |
          aws s3 cp pcr-measurements-*.json s3://midnight-proof-server-pcrs/${GITHUB_REF_NAME}/
```

## Verification for External Parties

Community members can independently verify PCRs:

```bash
# 1. Clone repository
git clone https://github.com/midnight/midnight-ledger
cd midnight-ledger
git checkout v6.3.1

# 2. Build identical Docker image
docker build -f tee-proof-server-proto/Dockerfile -t midnight/proof-server:v6.3.1 .

# 3. Build EIF and extract PCRs
nitro-cli build-enclave \
  --docker-uri midnight/proof-server:v6.3.1 \
  --output-file proof-server.eif | tee build-output.txt

# 4. Compare against published PCRs
PUBLISHED_PCR0=$(curl -s https://github.com/.../pcr-measurements.json | jq -r '.measurements.pcr0.value')
BUILT_PCR0=$(grep "PCR0" build-output.txt | sed 's/.*"PCR0": "\(.*\)".*/\1/')

if [ "$PUBLISHED_PCR0" = "$BUILT_PCR0" ]; then
  echo "✓ PCR0 matches - build is reproducible"
else
  echo "✗ PCR0 mismatch - investigate!"
fi
```

## Security Considerations

### Signing PCR Publications

For maximum security, sign PCR files with GPG:

```bash
# Generate PCR file
./deploy-nitro-enclave.sh

# Sign with GPG
gpg --armor --detach-sign pcr-measurements-v6.3.1.json

# Publish both files
gh release upload v6.3.1 \
  pcr-measurements-v6.3.1.json \
  pcr-measurements-v6.3.1.json.asc
```

Clients can verify signatures:
```bash
gpg --verify pcr-measurements-v6.3.1.json.asc pcr-measurements-v6.3.1.json
```

### Multi-Party Verification

For critical deployments, have multiple parties independently:
1. Build the enclave
2. Verify PCR values match
3. Co-sign the PCR publication

### Transparency Log

Maintain a public log of all PCR publications:

```
# pcr-history.md
| Version | Date | PCR0 | Signed By | Notes |
|---------|------|------|-----------|-------|
| v6.3.1  | 2026-01-08 | 32799fb... | team@midnight | Initial devnet |
| v6.3.2  | 2026-01-09 | a1b2c3d... | team@midnight | Bug fix |
```

## Troubleshooting

### PCR Extraction Failed

If deployment script shows `null` PCRs:
```bash
# Check build-output.txt exists
cat build-output.txt

# Manually extract
grep -A 5 "Measurements" build-output.txt
```

### Published PCRs Don't Match Running Enclave

```bash
# Get actual PCRs from running enclave
nitro-cli describe-enclaves | jq '.[0].Measurements'

# Compare with published
curl https://cdn.midnight.network/.../pcr-measurements.json | jq '.measurements'

# If mismatch, wrong version is deployed
```

### Clients Can't Fetch PCRs

- Check CORS headers on hosting
- Verify HTTPS certificate is valid
- Test from multiple networks
- Check CDN/cache TTL settings

## Best Practices

1. **Always publish immediately after deployment**
2. **Use multiple publication channels**
3. **Sign PCR files for authenticity**
4. **Document build process for reproducibility**
5. **Maintain PCR version history**
6. **Monitor fetch errors from clients**
7. **Set reasonable cache TTLs (5-15 minutes)**
8. **Test PCR fetch before announcing deployment**

## Future Enhancements

- [ ] Automated PCR publishing in CI/CD
- [ ] On-chain PCR publication (blockchain)
- [ ] DNS TXT record publication
- [ ] Multi-signature PCR attestation
- [ ] PCR transparency log service
- [ ] Automated reproducible build verification
